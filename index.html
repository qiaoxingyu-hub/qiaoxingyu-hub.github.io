<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>米小兜AI助手</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #5E81F4;
      --primary-light: #8EA7F9;
      --primary-dark: #3D63D4;
      --secondary: #FF7AC6;
      --bg-light: #F5F7FF;
      --bg-white: #FFFFFF;
      --text-dark: #2E384D;
      --text-light: #8C94A7;
      --shadow: 0 10px 30px rgba(94, 129, 244, 0.15);
      --radius: 16px;
    }

    body {
      font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #F5F7FF 0%, #E6EBFF 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--text-dark);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 800px;
      background: var(--bg-white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 90vh;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 20px 30px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .status-indicator {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4CD964;
      margin-right: 8px;
    }

    /* 应用按钮样式 */
    .app-btn {
      display: inline-block;
      padding: 10px 20px;
      background: var(--primary);
      color: white;
      border-radius: 8px;
      text-decoration: none;
      font-size: 16px;
      line-height: 1.2;
      box-shadow: 0 2px 6px rgba(94, 129, 244, 0.35);
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
      margin-top: 10px;
      border: none;
      cursor: pointer;
    }
    
    .app-btn:hover {
      transform: translateY(-1px);
      background: var(--primary-dark);
      box-shadow: 0 6px 16px rgba(94, 129, 244, 0.35);
      color: white;
    }
    
    .app-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(94, 129, 244, 0.35);
    }

    /* 聊天区域样式 */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow: hidden;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
    }

    .message {
      max-width: 80%;
      padding: 12px 18px;
      margin-bottom: 15px;
      border-radius: 18px;
      line-height: 1.4;
      position: relative;
      animation: fadeIn 0.3s ease;
    }

    .user-message {
      align-self: flex-end;
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 6px;
    }

    .ai-message {
      align-self: flex-start;
      background: var(--bg-light);
      color: var(--text-dark);
      border-bottom-left-radius: 6px;
    }

    .message-time {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 5px;
      text-align: right;
    }

    .ai-message .message-time {
      text-align: left;
    }

    /* 输入区域 */
    .input-container {
      display: flex;
      background: var(--bg-light);
      border-radius: 24px;
      padding: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    #userInput {
      flex: 1;
      border: none;
      background: transparent;
      padding: 12px 20px;
      font-size: 1rem;
      outline: none;
      color: var(--text-dark);
    }

    #userInput::placeholder {
      color: var(--text-light);
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 8px rgba(94, 129, 244, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(94, 129, 244, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-voice {
      background: var(--secondary);
      box-shadow: 0 4px 8px rgba(255, 122, 198, 0.3);
    }

    .btn-voice.listening {
      animation: pulse 1.5s infinite;
    }

    .btn-speak {
      background: var(--primary-light);
    }

    .btn:disabled {
      background: var(--text-light);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .voice-status {
      text-align: center;
      margin: 10px 0;
      color: var(--primary);
      font-size: 0.9rem;
      min-height: 20px;
    }

    /* 微信提示 */
    .wechat-tip {
      background: #FFF6E0;
      border: 1px solid #FFD351;
      border-radius: 8px;
      padding: 10px 15px;
      margin-bottom: 15px;
      font-size: 0.85rem;
      color: #8C6C0F;
      display: none;
    }

    /* 语音功能提示 */
    .voice-help {
      background: #E8F4FD;
      border: 1px solid #B8D9F0;
      border-radius: 8px;
      padding: 12px 15px;
      margin-bottom: 15px;
      font-size: 0.85rem;
      color: #2C5B8A;
    }

    .voice-help ul {
      margin: 8px 0;
      padding-left: 20px;
    }

    .voice-help li {
      margin-bottom: 5px;
    }

    /* 动画 */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 122, 198, 0.7); }
      70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 122, 198, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 122, 198, 0); }
    }

    /* 响应式设计 */
    @media (max-width: 600px) {
      .container {
        height: 95vh;
      }
      
      .header {
        padding: 15px 20px;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .chat-container {
        padding: 15px;
      }
      
      .message {
        max-width: 90%;
      }
    }

    /* 滚动条样式 */
    #chat::-webkit-scrollbar {
      width: 6px;
    }

    #chat::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    #chat::-webkit-scrollbar-thumb {
      background: var(--primary-light);
      border-radius: 10px;
    }

    #chat::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 头部 -->
    <div class="header">
      <h1>米小兜AI助手</h1>
      <p>您的智能对话伙伴</p>
      <!-- 添加应用跳转按钮 -->
      <a href="edu/index.html" class="app-btn">
        📚 打开学习应用
      </a>
      <div class="status-indicator">
        <div class="status-dot"></div>
        <span>在线</span>
      </div>
    </div>

    <!-- 聊天区域 -->
    <div class="chat-container">
      <div class="wechat-tip" id="wechatTip">
        提示：在微信中首次使用语音功能，需要点击"允许"使用麦克风权限。
      </div>
      
      <div class="voice-help" id="voiceHelp">
        <strong>语音功能使用提示：</strong>
        <ul>
          <li>语音功能在Chrome、Edge等浏览器中效果最佳</li>
          <li>首次使用需要授权麦克风权限</li>
          <li>确保麦克风设备正常工作</li>
          <li>在安静环境中使用效果更好</li>
        </ul>
      </div>
      
      <div id="chat">
        <div class="message ai-message">
          嗨！我是米小兜，您的AI助手。有什么我可以帮您的吗？
          <div class="message-time">刚刚</div>
        </div>
      </div>
      
      <div class="voice-status" id="voiceStatus"></div>
      
      <div class="input-container">
        <input type="text" id="userInput" placeholder="输入您的问题...">
        <div class="action-buttons">
          <button class="btn btn-voice" id="voiceButton" onclick="toggleVoiceRecognition()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
              <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            </svg>
          </button>
          <button class="btn" onclick="sendMessage()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
          <button class="btn btn-speak" onclick="speakLastMessage()" id="speakButton" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
              <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 🔑 配置你的API信息 - 请替换成你自己的！
    const API_KEY = 'sk-cf810705e966476eb6aabf5651e42163'; // 请在此处填入你从阿里云百炼获取的API密钥
    const API_URL = 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions'; // 千问的OpenAI兼容接口地址
    const MODEL_NAME = 'qwen-max'; // 你打算使用的模型名称，例如 qwen-max, qwen-turbo 等

    // 用于保存对话历史，让AI有上下文记忆
    let conversationHistory = [
      { 
        role: "system", 
        content: "你是一个名叫米小兜的AI助手，回答风格亲切友善、专业且简洁。你专注于帮助用户解决问题，提供有用的信息和建议。" 
      }
    ];

    // 语音识别相关变量
    let recognition = null;
    let isListening = false;
    let lastAIResponse = "";
    let isWeChat = false; // 标记是否在微信环境中
    
    // 检测是否在微信中打开
    function detectWeChat() {
      const ua = navigator.userAgent.toLowerCase();
      return ua.indexOf('micromessenger') !== -1;
    }
    
    // 获取当前时间
    function getCurrentTime() {
      const now = new Date();
      return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    }
    
    // 检查浏览器是否支持语音识别
    function initializeSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      
      if (!SpeechRecognition) {
        document.getElementById('voiceStatus').textContent = "您的浏览器不支持语音识别功能，请使用Chrome或Edge浏览器";
        document.getElementById('voiceButton').disabled = true;
        document.getElementById('voiceHelp').innerHTML = `
          <strong>语音功能不可用</strong>
          <p>您的浏览器不支持语音识别功能，请尝试以下解决方案：</p>
          <ul>
            <li>使用Chrome、Edge或Safari浏览器</li>
            <li>确保浏览器版本较新</li>
            <li>或直接使用文字输入与AI交流</li>
          </ul>
        `;
        return false;
      }
      
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'zh-CN';
      
      recognition.onstart = function() {
        isListening = true;
        document.getElementById('voiceButton').classList.add('listening');
        document.getElementById('voiceStatus').textContent = "正在聆听...请说话";
      };
      
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('userInput').value = transcript;
        document.getElementById('voiceStatus').textContent = `识别结果: ${transcript}`;
        
        // 自动发送识别到的语音内容
        setTimeout(() => {
          sendMessage();
        }, 500);
      };
      
      recognition.onerror = function(event) {
        console.error('语音识别错误:', event.error);
        let errorMessage = '语音识别错误: ';
        
        switch(event.error) {
          case 'not-allowed':
          case 'permission-denied':
            errorMessage += '麦克风权限被拒绝。请检查浏览器设置，允许网站使用麦克风。';
            break;
          case 'no-speech':
            errorMessage += '没有检测到语音输入。请确保麦克风正常工作并说话。';
            break;
          case 'audio-capture':
            errorMessage += '无法捕获音频。请检查麦克风设备是否连接正常。';
            break;
          case 'network':
            errorMessage += '网络错误导致语音识别失败。请检查网络连接。';
            break;
          default:
            errorMessage += event.error;
        }
        
        document.getElementById('voiceStatus').textContent = errorMessage;
        stopVoiceRecognition();
        
        // 在微信中，提示用户授权麦克风
        if (isWeChat && (event.error === 'not-allowed' || event.error === 'permission-denied')) {
          document.getElementById('wechatTip').style.display = 'block';
        }
      };
      
      recognition.onend = function() {
        stopVoiceRecognition();
      };
      
      return true;
    }
    
    // 开始或停止语音识别
    function toggleVoiceRecognition() {
      if (!recognition) {
        if (!initializeSpeechRecognition()) {
          return;
        }
      }
      
      if (isListening) {
        stopVoiceRecognition();
      } else {
        startVoiceRecognition();
      }
    }
    
    // 开始语音识别
    function startVoiceRecognition() {
      try {
        recognition.start();
      } catch (error) {
        console.error('启动语音识别失败:', error);
        document.getElementById('voiceStatus').textContent = "启动语音识别失败，请重试";
        
        // 在微信中，提示用户授权麦克风
        if (isWeChat) {
          document.getElementById('wechatTip').style.display = 'block';
        }
      }
    }
    
    // 停止语音识别
    function stopVoiceRecognition() {
      if (recognition && isListening) {
        recognition.stop();
      }
      isListening = false;
      document.getElementById('voiceButton').classList.remove('listening');
    }
    
    // 语音合成 - 朗读AI的回复
    function speakText(text) {
      // 检查浏览器是否支持语音合成
      if (!('speechSynthesis' in window)) {
        alert("您的浏览器不支持语音合成功能");
        return;
      }
      
      // 停止任何正在进行的语音
      window.speechSynthesis.cancel();
      
      // 创建语音实例
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'zh-CN';
      utterance.rate = 1.0; // 正常语速
      utterance.pitch = 1.0; // 正常音调
      
      utterance.onstart = function() {
        document.getElementById('voiceStatus').textContent = "正在朗读回复...";
        document.getElementById('speakButton').disabled = true;
      };
      
      utterance.onend = function() {
        document.getElementById('voiceStatus').textContent = "";
        document.getElementById('speakButton').disabled = false;
      };
      
      utterance.onerror = function(event) {
        console.error('语音合成错误:', event.error);
        document.getElementById('voiceStatus').textContent = "语音朗读失败";
        document.getElementById('speakButton').disabled = false;
      };
      
      // 开始朗读
      window.speechSynthesis.speak(utterance);
    }
    
    // 朗读最后一条AI消息
    function speakLastMessage() {
      if (lastAIResponse) {
        speakText(lastAIResponse);
      } else {
        document.getElementById('voiceStatus').textContent = "没有可朗读的回复";
      }
    }

    // 发送消息函数 - 接入千问API
    async function sendMessage() {
      const userInput = document.getElementById('userInput');
      const message = userInput.value.trim();
      
      if (!message) return;

      const chatBox = document.getElementById('chat');
      const currentTime = getCurrentTime();
      
      // 在界面上显示用户输入
      chatBox.innerHTML += `
        <div class="message user-message">
          ${message}
          <div class="message-time">${currentTime}</div>
        </div>
      `;
      userInput.value = '';
      
      // 显示"思考中"的提示
      const thinkingId = "thinking-" + Date.now();
      chatBox.innerHTML += `
        <div class="message ai-message" id="${thinkingId}">
          米小兜正在思考...
          <div class="message-time">${currentTime}</div>
        </div>
      `;
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        // 将用户的新消息加入历史
        conversationHistory.push({ role: "user", content: message });

        // 调用千问API
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_KEY}` // 认证信息
          },
          body: JSON.stringify({
            model: MODEL_NAME,
            messages: conversationHistory, // 发送完整的对话历史
            temperature: 0.7 // 控制回答的随机性，0-1之间，越小越确定
          })
        });

        if (!response.ok) {
          throw new Error(`网络请求错误: ${response.status}`);
        }

        const data = await response.json();
        
        // 从API回复中提取AI的回答文本
        const aiReply = data.choices[0].message.content;
        lastAIResponse = aiReply; // 保存最后一条AI回复用于语音朗读
        
        // 将AI的回答也加入历史
        conversationHistory.push({ role: "assistant", content: aiReply });

        // 用AI的真实回复替换"思考中"提示
        document.getElementById(thinkingId).outerHTML = `
          <div class="message ai-message">
            ${aiReply}
            <div class="message-time">${getCurrentTime()}</div>
          </div>
        `;
        
        // 启用朗读按钮
        document.getElementById('speakButton').disabled = false;
        
      } catch (error) {
        console.error('出错了:', error);
        // 用错误信息替换"思考中"提示
        document.getElementById(thinkingId).outerHTML = `
          <div class="message ai-message">
            抱歉，我暂时无法回应。错误详情: ${error.message}
            <div class="message-time">${getCurrentTime()}</div>
          </div>
        `;
      }
      
      // 确保聊天框滚动到底部
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 支持按回车键发送消息
    document.getElementById('userInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // 初始化
    window.onload = function() {
      // 检测是否在微信中
      isWeChat = detectWeChat();
      if (isWeChat) {
        document.getElementById('wechatTip').style.display = 'block';
      }
      
      // 初始化语音识别
      initializeSpeechRecognition();
      
      const chat = document.getElementById('chat');
      setTimeout(() => {
        chat.innerHTML += `
          <div class="message ai-message">
            您可以使用文字或语音与我交流，点击麦克风按钮开始语音对话。
            也可以通过上方的"打开学习应用"按钮访问我的其他功能。
            <div class="message-time">${getCurrentTime()}</div>
          </div>
        `;
        chat.scrollTop = chat.scrollHeight;
      }, 1000);
    };
  </script>
</body>
</html>