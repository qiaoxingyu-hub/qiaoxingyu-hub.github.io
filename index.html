<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ç±³å°å…œAIåŠ©æ‰‹</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
   /* å·¥ä½œè®°å½•ä¸“ç”¨æ ·å¼ */
.work-record-form {
  background-color: var(--bg-light);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 20px;
}

.form-group {
  margin-bottom: 12px;
}

.form-label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  color: var(--text-primary);
}

.form-input, .form-textarea, .form-select {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  font-family: inherit;
  font-size: 0.9rem;
}

.form-textarea {
  min-height: 80px;
  resize: vertical;
}

.form-row {
  display: flex;
  gap: 12px;
}

.form-row .form-group {
  flex: 1;
}

.work-record-item {
  background-color: var(--bg-white);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
  position: relative;
}

.work-record-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.work-record-title {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.work-record-meta {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.work-record-content {
  margin: 8px 0;
  line-height: 1.5;
}

.work-record-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
}

.work-tag {
  background-color: rgba(16, 163, 127, 0.1);
  color: var(--primary);
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
}

.work-record-actions {
  position: absolute;
  top: 16px;
  right: 16px;
  display: flex;
  gap: 8px;
}

.record-action-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 0.8rem;
}

.record-action-btn:hover {
  color: var(--primary);
}

.summary-section {
  background-color: var(--bg-light);
  border-radius: var(--radius);
  padding: 16px;
  margin-top: 20px;
}

.summary-btn {
  background-color: var(--primary);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: var(--radius);
  cursor: pointer;
  margin-top: 10px;
  transition: background-color 0.2s;
  width: 100%;
}

.summary-btn:hover {
  background-color: var(--primary-dark);
}

.summary-result {
  margin-top: 16px;
  padding: 12px;
  background-color: var(--bg-white);
  border-radius: var(--radius);
  border: 1px solid var(--border-color);
}
 :root {
      --primary: #10a37f;
      --primary-light: #1abc9c;
      --primary-dark: #0d8c6c;
      --secondary: #3498db;
      --bg-light: #f7f7f8;
      --bg-white: #ffffff;
      --bg-panel: #f9f9f9;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --text-muted: #9ca3af;
      --border-color: #e5e7eb;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      --radius: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
      background-color: var(--bg-light);
      color: var(--text-primary);
      line-height: 1.5;
      overflow-x: hidden;
      height: 100vh;
    }

    .app-container {
      display: flex;
      height: 100vh;
      max-width: 100%;
      overflow: hidden;
    }

    /* å·¦ä¾§è¾¹æ æ ·å¼ */
    .sidebar {
      width: 260px;
      background-color: var(--bg-white);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
      z-index: 100;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .new-chat-btn {
      width: 100%;
      padding: 12px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background-color 0.2s;
      font-weight: 500;
    }

    .new-chat-btn:hover {
      background-color: var(--primary-dark);
    }

    .history-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .history-item {
      padding: 12px;
      border-radius: var(--radius);
      cursor: pointer;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: background-color 0.2s;
    }

    .history-item:hover {
      background-color: var(--bg-light);
    }

    .history-item.active {
      background-color: rgba(16, 163, 127, 0.1);
      color: var(--primary);
    }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid var(--border-color);
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
    }

    /* ä¸»å†…å®¹åŒºåŸŸ */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--bg-white);
      position: relative;
    }

    .chat-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--bg-white);
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 1.2rem;
      cursor: pointer;
    }

    .chat-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      background-color: var(--bg-white);
    }

    .message {
      padding: 24px 0;
    }

    .message-user {
      background-color: var(--bg-white);
    }

    .message-ai {
      background-color: var(--bg-white);
    }

    .message-content {
      max-width: 768px;
      margin: 0 auto;
      display: flex;
      gap: 16px;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      overflow: hidden;
    }

    .avatar-user {
      background-color: var(--secondary);
      color: white;
    }

    .avatar-ai {
      background-color: #ff9f43;
      color: white;
    }

    .avatar-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .message-text {
      flex: 1;
      padding-top: 4px;
    }

    .message-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .action-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.8rem;
      transition: color 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .action-btn:hover {
      color: var(--primary);
    }

    /* è¾“å…¥åŒºåŸŸ */
    .input-container {
      padding: 16px 24px;
      position: relative;
      max-width: 768px;
      margin: 0 auto;
      width: 100%;
      border-top: 1px solid var(--border-color);
      background-color: var(--bg-white);
    }

    .input-box {
      position: relative;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      background-color: var(--bg-white);
      box-shadow: var(--shadow);
    }

    .input-options {
      display: flex;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .option-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .option-btn.active {
      background-color: rgba(16, 163, 127, 0.1);
      color: var(--primary);
    }

    .option-btn:hover {
      background-color: var(--bg-light);
    }

    .input-area {
      display: flex;
      padding: 12px;
    }

    #userInput {
      flex: 1;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 1rem;
      resize: none;
      outline: none;
      max-height: 200px;
      min-height: 24px;
      line-height: 1.5;
    }

    #userInput::placeholder {
      color: var(--text-muted);
    }

    .send-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.2s;
      align-self: flex-end;
      margin-left: 12px;
    }

    .send-btn:hover {
      background-color: var(--primary-light);
    }

    .send-btn:disabled {
      background-color: var(--text-muted);
      cursor: not-allowed;
    }

    .input-footer {
      display: flex;
      justify-content: center;
      padding: 8px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .voice-status {
      text-align: center;
      margin: 8px 0;
      color: var(--primary);
      font-size: 0.8rem;
      min-height: 20px;
    }

    /* å³ä¾§åº”ç”¨æ  */
    .apps-sidebar {
      width: 220px;
      background-color: var(--bg-white);
      border-left: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      padding: 16px;
      overflow-y: auto;
    }

    .apps-header {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .app-card {
      background-color: var(--bg-light);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.2s;
      border: 1px solid var(--border-color);
    }

    .app-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .app-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      font-size: 1.2rem;
    }

    .edu-app .app-icon {
      background-color: #3498db;
      color: white;
    }

    .knowledge-app .app-icon {
      background-color: #9b59b6;
      color: white;
    }

    .app-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .app-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .app-btn {
      width: 100%;
      padding: 8px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background-color 0.2s;
    }

    .app-btn:hover {
      background-color: var(--primary-dark);
    }

    /* çŸ¥è¯†åº“æ¨¡æ€æ¡† */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: var(--bg-white);
      border-radius: var(--radius);
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .knowledge-manager {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .knowledge-section {
      background-color: var(--bg-light);
      border-radius: var(--radius);
      padding: 16px;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .knowledge-input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    .knowledge-tags {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      margin-top: 10px;
    }

    .add-knowledge-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      margin-top: 10px;
      transition: background-color 0.2s;
    }

    .add-knowledge-btn:hover {
      background-color: var(--primary-dark);
    }

    .knowledge-list {
      margin-top: 16px;
      max-height: 300px;
      overflow-y: auto;
    }

    .knowledge-item {
      background-color: var(--bg-white);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }

    .knowledge-content {
      margin-bottom: 8px;
    }

    .knowledge-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
    }

    .search-knowledge {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      margin-bottom: 10px;
    }

    /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
    @media (max-width: 1024px) {
      .apps-sidebar {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        position: absolute;
        height: 100%;
        transform: translateX(-100%);
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .mobile-menu-btn {
        display: block;
      }
      
      .message-content {
        padding: 0 16px;
      }
      
      .input-container {
        padding: 12px;
      }
      
      .chat-header {
        padding: 12px;
      }
      
      .modal-content {
        width: 95%;
        height: 95%;
      }
    }

    /* åŠ è½½åŠ¨ç”» */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: var(--text-muted);
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    .typing-dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes typing {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* è¯­éŸ³æŒ‰é’® */
    .voice-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 8px;
      border-radius: 4px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .voice-btn:hover {
      background-color: var(--bg-light);
      color: var(--primary);
    }

    .voice-btn.listening {
      color: #e74c3c;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- å·¦ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <button class="new-chat-btn" id="newChatBtn">
          <i class="fas fa-plus"></i>
          æ–°å¯¹è¯
        </button>
      </div>
      <div class="history-list" id="historyList">
        <!-- å¯¹è¯å†å²å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div class="sidebar-footer">
        <p>ç±³å°å…œAIåŠ©æ‰‹ v1.0</p>
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
      <div class="chat-header">
        <button class="mobile-menu-btn" id="mobileMenuBtn">
          <i class="fas fa-bars"></i>
        </button>
        <div class="chat-title" id="chatTitle">æ–°å¯¹è¯</div>
        <div></div> <!-- å ä½å…ƒç´  -->
      </div>

      <div class="chat-container" id="chatContainer">
        <!-- æ¬¢è¿æ¶ˆæ¯ -->
        <div class="message message-ai">
          <div class="message-content">
            <div class="avatar avatar-ai">
              <i class="fas fa-child"></i>
            </div>
            <div class="message-text">
              <p>ä½ å¥½ï¼æˆ‘æ˜¯ç±³å°å…œï¼Œä½ çš„AIå°ä¼™ä¼´ï¼Œå¾ˆé«˜å…´ä¸ºä½ æœåŠ¡ï¼</p>
              <p>æˆ‘å¯ä»¥å¸®åŠ©ä½ ï¼š</p>
              <ul>
                <li>å›ç­”å„ç§é—®é¢˜</li>
                <li>ä½¿ç”¨è¯­éŸ³è¾“å…¥ï¼ˆç‚¹å‡»éº¦å…‹é£å›¾æ ‡ï¼‰</li>
                <li>å¼€å¯æ·±åº¦æ€è€ƒæ¨¡å¼è·å¾—æ›´è¯¦ç»†çš„å›ç­”</li>
                <li>å¼€å¯è”ç½‘æœç´¢è·å–æœ€æ–°ä¿¡æ¯</li>
                <li>è®¿é—®å³ä¾§çš„åº”ç”¨ä¸­å¿ƒä½¿ç”¨æ›´å¤šåŠŸèƒ½</li>
              </ul>
              <div class="message-actions">
                <button class="action-btn" onclick="copyToClipboard(this)">
                  <i class="far fa-copy"></i> å¤åˆ¶
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- è¯­éŸ³çŠ¶æ€æ˜¾ç¤º -->
      <div class="voice-status" id="voiceStatus"></div>

      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="input-container">
        <div class="input-box">
          <div class="input-options">
            <button class="option-btn" id="deepThinkingBtn">
              <i class="fas fa-brain"></i> æ·±åº¦æ€è€ƒ
            </button>
            <button class="option-btn" id="webSearchBtn">
              <i class="fas fa-search"></i> è”ç½‘æœç´¢
            </button>
          </div>
          <div class="input-area">
            <textarea id="userInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." rows="1"></textarea>
            <button class="voice-btn" id="voiceButton">
              <i class="fas fa-microphone"></i>
            </button>
            <button class="send-btn" id="sendButton">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
        <div class="input-footer">
          <p>ç±³å°å…œå¯ä»¥çŠ¯é”™ï¼Œè¯·æ ¸å®é‡è¦ä¿¡æ¯</p>
        </div>
      </div>
    </div>

    <!-- å³ä¾§åº”ç”¨æ  -->
    <div class="apps-sidebar">
      <div class="apps-header">åº”ç”¨ä¸­å¿ƒ</div>
      
      <!-- èŒæ•™åŸ¹è®­åº”ç”¨ -->
      <div class="app-card edu-app">
        <div class="app-icon">
          <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="app-title">èŒæ•™åŸ¹è®­</div>
        <div class="app-description">
          è®¿é—®èŒä¸šæ•™è‚²åŸ¹è®­èµ„æºï¼Œå­¦ä¹ ä¸“ä¸šæŠ€èƒ½å’ŒçŸ¥è¯†
        </div>
        <button class="app-btn" onclick="window.open('edu/index.html', '_blank')">
          æ‰“å¼€åº”ç”¨
        </button>
      </div>
      
      <!-- çŸ¥è¯†åº“åº”ç”¨ -->
      <div class="app-card knowledge-app">
        <div class="app-icon">
          <i class="fas fa-database"></i>
        </div>
        <div class="app-title">çŸ¥è¯†åº“</div>
        <div class="app-description">
          ç®¡ç†ä½ çš„ä¸ªäººçŸ¥è¯†åº“ï¼Œè®©AIå­¦ä¹ ä½ çš„ä¸“ä¸šçŸ¥è¯†
        </div>
        <button class="app-btn" id="knowledgeBaseBtn">
          æ‰“å¼€çŸ¥è¯†åº“
        </button>
      </div>
      
      <!-- ç•™ç™½åŒºåŸŸï¼Œç”¨äºæœªæ¥æ·»åŠ æ›´å¤šåº”ç”¨ -->
      <div style="margin-top: 20px; text-align: center; color: var(--text-muted); font-size: 0.85rem;">
        <p>æ›´å¤šåº”ç”¨å³å°†ä¸Šçº¿</p>
      </div>
    </div>
  </div>

  <!-- çŸ¥è¯†åº“æ¨¡æ€æ¡† -->
<div class="modal" id="knowledgeModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">æˆ‘çš„çŸ¥è¯†åº“ & å·¥ä½œè®°å½•</div>
      <button class="close-btn" id="closeKnowledgeModal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="knowledge-manager">
        <!-- æ·»åŠ çŸ¥è¯†éƒ¨åˆ† -->
        <div class="knowledge-section">
          <div class="section-title">æ·»åŠ æ–°çŸ¥è¯†</div>
          <textarea class="knowledge-input" id="knowledgeInput" placeholder="è¾“å…¥ä½ æƒ³è®©AIå­¦ä¹ çš„å†…å®¹..."></textarea>
          <input type="text" class="knowledge-tags" id="knowledgeTags" placeholder="æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰">
          <button class="add-knowledge-btn" id="addKnowledgeBtn">æ·»åŠ åˆ°çŸ¥è¯†åº“</button>
        </div>
        
        <!-- å·¥ä½œè®°å½•éƒ¨åˆ† -->
        <div class="knowledge-section">
          <div class="section-title">å·¥ä½œè®°å½•</div>
          <div class="work-record-form">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">ä»»åŠ¡åç§°</label>
                <input type="text" class="form-input" id="workTaskName" placeholder="ä¾‹å¦‚ï¼šå®Œæˆé¡¹ç›®Açš„å‰ç«¯å¼€å‘">
              </div>
              <div class="form-group">
                <label class="form-label">é¡¹ç›®åç§°</label>
                <input type="text" class="form-input" id="workProjectName" placeholder="ä¾‹å¦‚ï¼šAIåŠ©æ‰‹é¡¹ç›®">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
                <input type="date" class="form-input" id="workStartDate">
              </div>
              <div class="form-group">
                <label class="form-label">å®Œæˆæ—¥æœŸ</label>
                <input type="date" class="form-input" id="workEndDate">
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">å·¥ä½œå†…å®¹æè¿°</label>
              <textarea class="form-textarea" id="workDescription" placeholder="è¯¦ç»†æè¿°å®Œæˆçš„å·¥ä½œå†…å®¹ã€ä½¿ç”¨çš„æŠ€æœ¯ã€è§£å†³çš„é—®é¢˜ç­‰..."></textarea>
            </div>
            
            <div class="form-group">
              <label class="form-label">æˆæœä¸äº®ç‚¹</label>
              <textarea class="form-textarea" id="workAchievements" placeholder="æè¿°å·¥ä½œæˆæœã€è¾¾æˆçš„ç›®æ ‡ã€è·å¾—çš„è®¤å¯ç­‰..."></textarea>
            </div>
            
            <div class="form-group">
              <label class="form-label">æŠ€èƒ½æ ‡ç­¾</label>
              <input type="text" class="form-input" id="workSkills" placeholder="ä¾‹å¦‚ï¼šReact,Node.js,é¡¹ç›®ç®¡ç†,å›¢é˜Ÿåä½œ">
            </div>
            
            <button class="add-knowledge-btn" id="addWorkRecordBtn">æ·»åŠ å·¥ä½œè®°å½•</button>
          </div>
          
          <!-- å·¥ä½œè®°å½•åˆ—è¡¨ -->
          <div class="work-record-list" id="workRecordList">
            <!-- å·¥ä½œè®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        
        <!-- å¹´åº¦æ€»ç»“ç”Ÿæˆéƒ¨åˆ† -->
        <div class="summary-section">
          <div class="section-title">å¹´åº¦æ€»ç»“ç”Ÿæˆ</div>
          <p style="margin-bottom: 12px; font-size: 0.9rem; color: var(--text-secondary);">
            åŸºäºä½ çš„å·¥ä½œè®°å½•ï¼ŒAIå°†ç”Ÿæˆä¸“ä¸šçš„å¹´åº¦å·¥ä½œæ€»ç»“
          </p>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">æ€»ç»“å¹´ä»½</label>
              <select class="form-select" id="summaryYear">
                <option value="2024">2024å¹´</option>
                <option value="2023">2023å¹´</option>
                <option value="2022">2022å¹´</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">æ€»ç»“ç±»å‹</label>
              <select class="form-select" id="summaryType">
                <option value="personal">ä¸ªäººå·¥ä½œæ€»ç»“</option>
                <option value="technical">æŠ€æœ¯èƒ½åŠ›æ€»ç»“</option>
                <option value="project">é¡¹ç›®æˆæœæ€»ç»“</option>
              </select>
            </div>
          </div>
          <button class="summary-btn" id="generateSummaryBtn">ç”Ÿæˆå¹´åº¦æ€»ç»“</button>
          <div class="summary-result" id="summaryResult" style="display: none;">
            <!-- æ€»ç»“ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
          </div>
        </div>
        
        <!-- æœç´¢çŸ¥è¯†éƒ¨åˆ† -->
        <div class="knowledge-section">
          <div class="section-title">æœç´¢çŸ¥è¯†</div>
          <input type="text" class="search-knowledge" id="searchKnowledge" placeholder="æœç´¢çŸ¥è¯†åº“...">
          <button class="add-knowledge-btn" id="searchKnowledgeBtn">æœç´¢</button>
        </div>
        
        <!-- çŸ¥è¯†åˆ—è¡¨éƒ¨åˆ† -->
        <div class="knowledge-section">
          <div class="section-title">æˆ‘çš„çŸ¥è¯†åº“</div>
          <div class="knowledge-list" id="knowledgeList">
            <!-- çŸ¥è¯†æ¡ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

  <script>
    // é…ç½®
    const API_KEY = 'sk-cf810705e966476eb6aabf5651e42163';
    const API_URL = 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
    const MODEL_NAME = 'qwen-max';

    // çŠ¶æ€ç®¡ç†
    let conversationHistory = [];
    let chatSessions = [];
    let currentSessionId = null;
    let isDeepThinking = false;
    let isWebSearch = false;
    let recognition = null;
    let isListening = false;
    let lastAIResponse = "";
    
    // çŸ¥è¯†åº“æ•°æ®
    let knowledgeBase = [];

    // DOM å…ƒç´ 
    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const historyList = document.getElementById('historyList');
    const chatContainer = document.getElementById('chatContainer');
    const chatTitle = document.getElementById('chatTitle');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const voiceButton = document.getElementById('voiceButton');
    const voiceStatus = document.getElementById('voiceStatus');
    const deepThinkingBtn = document.getElementById('deepThinkingBtn');
    const webSearchBtn = document.getElementById('webSearchBtn');
    const knowledgeBaseBtn = document.getElementById('knowledgeBaseBtn');
    const knowledgeModal = document.getElementById('knowledgeModal');
    const closeKnowledgeModal = document.getElementById('closeKnowledgeModal');
    const knowledgeInput = document.getElementById('knowledgeInput');
    const knowledgeTags = document.getElementById('knowledgeTags');
    const addKnowledgeBtn = document.getElementById('addKnowledgeBtn');
    const searchKnowledge = document.getElementById('searchKnowledge');
    const searchKnowledgeBtn = document.getElementById('searchKnowledgeBtn');
    const knowledgeList = document.getElementById('knowledgeList');

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      loadChatSessions();
      loadKnowledgeBase();
      initializeVoiceRecognition();
      setupEventListeners();
      autoResizeTextarea();
    });
// åœ¨é…ç½®å¸¸é‡åæ·»åŠ å·¥ä½œè®°å½•æ•°æ®
let workRecords = [];

// åœ¨åˆå§‹åŒ–å‡½æ•°ä¸­æ·»åŠ å·¥ä½œè®°å½•åŠ è½½
document.addEventListener('DOMContentLoaded', function() {
  // å·²æœ‰çš„åˆå§‹åŒ–ä»£ç ...
  loadWorkRecords();
  
  // æ·»åŠ å·¥ä½œè®°å½•æŒ‰é’®äº‹ä»¶
  document.getElementById('addWorkRecordBtn').addEventListener('click', addWorkRecord);
  
  // ç”Ÿæˆæ€»ç»“æŒ‰é’®äº‹ä»¶
  document.getElementById('generateSummaryBtn').addEventListener('click', generateSummary);
});

// åœ¨å·¥ä½œè®°å½•ç›¸å…³å‡½æ•°åŒºåŸŸæ·»åŠ ä»¥ä¸‹å‡½æ•°
function loadWorkRecords() {
  const saved = localStorage.getItem('workRecords');
  if (saved) {
    workRecords = JSON.parse(saved);
    renderWorkRecordList();
  }
}

function saveWorkRecords() {
  localStorage.setItem('workRecords', JSON.stringify(workRecords));
}

function addWorkRecord() {
  const taskName = document.getElementById('workTaskName').value.trim();
  const projectName = document.getElementById('workProjectName').value.trim();
  const startDate = document.getElementById('workStartDate').value;
  const endDate = document.getElementById('workEndDate').value;
  const description = document.getElementById('workDescription').value.trim();
  const achievements = document.getElementById('workAchievements').value.trim();
  const skills = document.getElementById('workSkills').value.split(',').map(skill => skill.trim()).filter(skill => skill);
  
  if (!taskName || !projectName || !startDate || !description) {
    alert('è¯·å¡«å†™å¿…å¡«å­—æ®µï¼šä»»åŠ¡åç§°ã€é¡¹ç›®åç§°ã€å¼€å§‹æ—¥æœŸå’Œå·¥ä½œæè¿°');
    return;
  }
  
  const workRecord = {
    id: Date.now(),
    taskName: taskName,
    projectName: projectName,
    startDate: startDate,
    endDate: endDate || startDate,
    description: description,
    achievements: achievements,
    skills: skills,
    createdAt: new Date().toISOString()
  };
  
  workRecords.push(workRecord);
  saveWorkRecords();
  renderWorkRecordList();
  
  // åŒæ—¶å°†å·¥ä½œè®°å½•æ·»åŠ åˆ°çŸ¥è¯†åº“ï¼Œä¾¿äºAIæ£€ç´¢
  const knowledgeContent = `ã€å·¥ä½œè®°å½•ã€‘\nä»»åŠ¡ï¼š${taskName}\né¡¹ç›®ï¼š${projectName}\næ—¶é—´ï¼š${startDate} è‡³ ${endDate || startDate}\nå·¥ä½œå†…å®¹ï¼š${description}\n${achievements ? `æˆæœäº®ç‚¹ï¼š${achievements}\n` : ''}æŠ€èƒ½æ ‡ç­¾ï¼š${skills.join(', ')}`;
  
  const knowledgeItem = {
    id: 'work_' + workRecord.id,
    content: knowledgeContent,
    tags: ['å·¥ä½œè®°å½•', projectName, ...skills],
    createdAt: new Date().toISOString()
  };
  
  knowledgeBase.push(knowledgeItem);
  saveKnowledgeBase();
  renderKnowledgeList();
  
  // æ¸…ç©ºè¡¨å•
  document.getElementById('workTaskName').value = '';
  document.getElementById('workProjectName').value = '';
  document.getElementById('workStartDate').value = '';
  document.getElementById('workEndDate').value = '';
  document.getElementById('workDescription').value = '';
  document.getElementById('workAchievements').value = '';
  document.getElementById('workSkills').value = '';
}

function renderWorkRecordList() {
  const workRecordList = document.getElementById('workRecordList');
  workRecordList.innerHTML = '';
  
  if (workRecords.length === 0) {
    workRecordList.innerHTML = '<p style="text-align: center; color: var(--text-muted);">æš‚æ— å·¥ä½œè®°å½•</p>';
    return;
  }
  
  // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
  const sortedRecords = [...workRecords].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
  
  sortedRecords.forEach(record => {
    const recordElement = document.createElement('div');
    recordElement.className = 'work-record-item';
    
    const duration = record.endDate === record.startDate ? 
      formatDate(record.startDate) : 
      `${formatDate(record.startDate)} è‡³ ${formatDate(record.endDate)}`;
    
    recordElement.innerHTML = `
      <div class="work-record-header">
        <div>
          <div class="work-record-title">${record.taskName}</div>
          <div class="work-record-meta">${record.projectName} | ${duration}</div>
        </div>
        <div class="work-record-actions">
          <button class="record-action-btn" onclick="editWorkRecord(${record.id})">
            <i class="fas fa-edit"></i>
          </button>
          <button class="record-action-btn" onclick="deleteWorkRecord(${record.id})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      <div class="work-record-content">
        <div><strong>å·¥ä½œå†…å®¹ï¼š</strong>${record.description}</div>
        ${record.achievements ? `<div><strong>æˆæœäº®ç‚¹ï¼š</strong>${record.achievements}</div>` : ''}
      </div>
      <div class="work-record-tags">
        ${record.skills.map(skill => `<span class="work-tag">${skill}</span>`).join('')}
      </div>
    `;
    
    workRecordList.appendChild(recordElement);
  });
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
}

function deleteWorkRecord(id) {
  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å·¥ä½œè®°å½•å—ï¼Ÿ')) {
    workRecords = workRecords.filter(record => record.id !== id);
    saveWorkRecords();
    renderWorkRecordList();
    
    // åŒæ—¶ä»çŸ¥è¯†åº“ä¸­åˆ é™¤å¯¹åº”çš„è®°å½•
    knowledgeBase = knowledgeBase.filter(item => item.id !== 'work_' + id);
    saveKnowledgeBase();
    renderKnowledgeList();
  }
}

function editWorkRecord(id) {
  const record = workRecords.find(r => r.id === id);
  if (record) {
    // å¡«å……è¡¨å•
    document.getElementById('workTaskName').value = record.taskName;
    document.getElementById('workProjectName').value = record.projectName;
    document.getElementById('workStartDate').value = record.startDate;
    document.getElementById('workEndDate').value = record.endDate;
    document.getElementById('workDescription').value = record.description;
    document.getElementById('workAchievements').value = record.achievements || '';
    document.getElementById('workSkills').value = record.skills.join(', ');
    
    // åˆ é™¤åŸè®°å½•
    deleteWorkRecord(id);
    
    // æ»šåŠ¨åˆ°è¡¨å•
    document.querySelector('.work-record-form').scrollIntoView({ behavior: 'smooth' });
  }
}

async function generateSummary() {
  const year = document.getElementById('summaryYear').value;
  const type = document.getElementById('summaryType').value;
  
  // ç­›é€‰æŒ‡å®šå¹´ä»½çš„å·¥ä½œè®°å½•
  const yearRecords = workRecords.filter(record => {
    const recordYear = new Date(record.startDate).getFullYear().toString();
    return recordYear === year;
  });
  
  if (yearRecords.length === 0) {
    document.getElementById('summaryResult').innerHTML = `<p>${year}å¹´åº¦æš‚æ— å·¥ä½œè®°å½•ï¼Œè¯·å…ˆæ·»åŠ å·¥ä½œè®°å½•ã€‚</p>`;
    document.getElementById('summaryResult').style.display = 'block';
    return;
  }
  
  // æ˜¾ç¤ºç”Ÿæˆä¸­çŠ¶æ€
  document.getElementById('summaryResult').innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> AIæ­£åœ¨ç”Ÿæˆå¹´åº¦æ€»ç»“...</p>';
  document.getElementById('summaryResult').style.display = 'block';
  
  try {
    // æ„å»ºå·¥ä½œè®°å½•æ‘˜è¦
    let workSummary = `${year}å¹´åº¦å·¥ä½œè®°å½•æ‘˜è¦ï¼š\n\n`;
    yearRecords.forEach((record, index) => {
      workSummary += `${index + 1}. ã€${record.projectName}ã€‘${record.taskName}ï¼ˆ${formatDate(record.startDate)}ï¼‰\n`;
      workSummary += `   å·¥ä½œå†…å®¹ï¼š${record.description}\n`;
      if (record.achievements) {
        workSummary += `   æˆæœäº®ç‚¹ï¼š${record.achievements}\n`;
      }
      workSummary += `   æŠ€èƒ½åº”ç”¨ï¼š${record.skills.join('ã€')}\n\n`;
    });
    
    // æ ¹æ®ç±»å‹æ„å»ºä¸åŒçš„æç¤ºè¯
    let prompt = '';
    switch(type) {
      case 'personal':
        prompt = `è¯·æ ¹æ®ä»¥ä¸‹å·¥ä½œè®°å½•ï¼Œä¸ºæˆ‘ç”Ÿæˆä¸€ä»½${year}å¹´åº¦çš„ä¸ªäººå·¥ä½œæ€»ç»“ã€‚è¦æ±‚ï¼š\n1. æ¦‚æ‹¬å…¨å¹´å·¥ä½œæˆæœ\n2. çªå‡ºä¸ªäººè´¡çŒ®å’Œæˆé•¿\n3. åˆ†æä¸è¶³ä¸æ”¹è¿›æ–¹å‘\n4. å±•æœ›æœªæ¥å·¥ä½œè®¡åˆ’\n5. è¯­è¨€ä¸“ä¸šã€æ¡ç†æ¸…æ™°\n\n${workSummary}`;
        break;
      case 'technical':
        prompt = `è¯·æ ¹æ®ä»¥ä¸‹å·¥ä½œè®°å½•ï¼Œä¸ºæˆ‘ç”Ÿæˆä¸€ä»½${year}å¹´åº¦çš„æŠ€æœ¯èƒ½åŠ›æ€»ç»“ã€‚è¦æ±‚ï¼š\n1. æ€»ç»“æŠ€æœ¯æ ˆåº”ç”¨æƒ…å†µ\n2. åˆ†ææŠ€æœ¯éš¾ç‚¹å’Œè§£å†³æ–¹æ¡ˆ\n3. è¯„ä¼°æŠ€èƒ½æˆé•¿è·¯å¾„\n4. è§„åˆ’æœªæ¥æŠ€æœ¯å­¦ä¹ æ–¹å‘\n5. è¯­è¨€ä¸“ä¸šã€æŠ€æœ¯æœ¯è¯­å‡†ç¡®\n\n${workSummary}`;
        break;
      case 'project':
        prompt = `è¯·æ ¹æ®ä»¥ä¸‹å·¥ä½œè®°å½•ï¼Œä¸ºæˆ‘ç”Ÿæˆä¸€ä»½${year}å¹´åº¦çš„é¡¹ç›®æˆæœæ€»ç»“ã€‚è¦æ±‚ï¼š\n1. æ¦‚è¿°å„é¡¹ç›®å®Œæˆæƒ…å†µ\n2. é‡åŒ–é¡¹ç›®æˆæœå’Œå½±å“\n3. åˆ†æé¡¹ç›®ç®¡ç†ç»éªŒ\n4. æ€»ç»“å›¢é˜Ÿåä½œæ•ˆæœ\n5. è¯­è¨€ä¸“ä¸šã€æ•°æ®æ”¯æ’‘\n\n${workSummary}`;
        break;
    }
    
    // è°ƒç”¨AIç”Ÿæˆæ€»ç»“
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_KEY}`
      },
      body: JSON.stringify({
        model: MODEL_NAME,
        messages: [
          { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„èŒåœºé¡¾é—®ï¼Œæ“…é•¿æ ¹æ®å·¥ä½œè®°å½•ç”Ÿæˆå„ç§ç±»å‹çš„æ€»ç»“æŠ¥å‘Šã€‚" },
          { role: "user", content: prompt }
        ],
        temperature: 0.7
      })
    });

    if (!response.ok) {
      throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
    }

    const data = await response.json();
    const summary = data.choices[0].message.content;
    
    // æ˜¾ç¤ºç”Ÿæˆçš„æ€»ç»“
    document.getElementById('summaryResult').innerHTML = `
      <div style="margin-bottom: 12px;">
        <strong>${year}å¹´åº¦${getSummaryTypeName(type)}ï¼š</strong>
      </div>
      <div style="white-space: pre-wrap; line-height: 1.6;">${summary}</div>
      <div style="margin-top: 12px; text-align: center;">
        <button class="add-knowledge-btn" onclick="copyToClipboard('${summary.replace(/'/g, "\\'")}')">
          <i class="far fa-copy"></i> å¤åˆ¶æ€»ç»“
        </button>
      </div>
    `;
    
  } catch (error) {
    console.error('ç”Ÿæˆæ€»ç»“å¤±è´¥:', error);
    document.getElementById('summaryResult').innerHTML = `<p>ç”Ÿæˆæ€»ç»“å¤±è´¥ï¼š${error.message}</p>`;
  }
}

function getSummaryTypeName(type) {
  switch(type) {
    case 'personal': return 'ä¸ªäººå·¥ä½œæ€»ç»“';
    case 'technical': return 'æŠ€æœ¯èƒ½åŠ›æ€»ç»“';
    case 'project': return 'é¡¹ç›®æˆæœæ€»ç»“';
    default: return 'å·¥ä½œæ€»ç»“';
  }
}

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      // ç§»åŠ¨ç«¯èœå•
      mobileMenuBtn.addEventListener('click', toggleSidebar);
      
      // æ–°å¯¹è¯æŒ‰é’®
      newChatBtn.addEventListener('click', createNewChat);
      
      // å‘é€æ¶ˆæ¯
      sendButton.addEventListener('click', sendMessage);
      userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // è¯­éŸ³æŒ‰é’®
      voiceButton.addEventListener('click', toggleVoiceRecognition);
      
      // åŠŸèƒ½æŒ‰é’®
      deepThinkingBtn.addEventListener('click', function() {
        isDeepThinking = !isDeepThinking;
        this.classList.toggle('active', isDeepThinking);
      });
      
      webSearchBtn.addEventListener('click', function() {
        isWebSearch = !isWebSearch;
        this.classList.toggle('active', isWebSearch);
      });
      
      // çŸ¥è¯†åº“æŒ‰é’®
      knowledgeBaseBtn.addEventListener('click', function() {
        knowledgeModal.style.display = 'flex';
      });
      
      // å…³é—­çŸ¥è¯†åº“æ¨¡æ€æ¡†
      closeKnowledgeModal.addEventListener('click', function() {
        knowledgeModal.style.display = 'none';
      });
      
      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      knowledgeModal.addEventListener('click', function(e) {
        if (e.target === knowledgeModal) {
          knowledgeModal.style.display = 'none';
        }
      });
      
      // æ·»åŠ çŸ¥è¯†
      addKnowledgeBtn.addEventListener('click', addKnowledge);
      
      // æœç´¢çŸ¥è¯†
      searchKnowledgeBtn.addEventListener('click', searchKnowledgeBase);
      searchKnowledge.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          searchKnowledgeBase();
        }
      });
    }

    // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŒºåŸŸé«˜åº¦
    function autoResizeTextarea() {
      userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });
    }

    // åˆ‡æ¢ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
    function toggleSidebar() {
      sidebar.classList.toggle('open');
    }

    // åˆ›å»ºæ–°å¯¹è¯
    function createNewChat() {
      const sessionId = 'chat_' + Date.now();
      const session = {
        id: sessionId,
        title: 'æ–°å¯¹è¯',
        createdAt: new Date().toISOString(),
        messages: []
      };
      
      chatSessions.push(session);
      currentSessionId = sessionId;
      conversationHistory = [];
      
      // æ›´æ–°UI
      chatContainer.innerHTML = '';
      chatTitle.textContent = 'æ–°å¯¹è¯';
      userInput.value = '';
      
      // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
      addMessage('ai', 'ä½ å¥½ï¼æˆ‘æ˜¯ç±³å°å…œï¼Œä½ çš„AIå°ä¼™ä¼´ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ');
      
      // ä¿å­˜å¹¶æ›´æ–°å†å²åˆ—è¡¨
      saveChatSessions();
      renderHistoryList();
      
      // åœ¨ç§»åŠ¨ç«¯å…³é—­ä¾§è¾¹æ 
      if (window.innerWidth <= 768) {
        sidebar.classList.remove('open');
      }
    }

    // åŠ è½½å¯¹è¯ä¼šè¯
    function loadChatSessions() {
      const saved = localStorage.getItem('chatSessions');
      if (saved) {
        chatSessions = JSON.parse(saved);
        renderHistoryList();
        
        if (chatSessions.length > 0) {
          // åŠ è½½æœ€æ–°ä¼šè¯
          const latestSession = chatSessions[chatSessions.length - 1];
          loadChatSession(latestSession.id);
        } else {
          createNewChat();
        }
      } else {
        createNewChat();
      }
    }

    // ä¿å­˜å¯¹è¯ä¼šè¯
    function saveChatSessions() {
      localStorage.setItem('chatSessions', JSON.stringify(chatSessions));
    }

    // æ¸²æŸ“å†å²åˆ—è¡¨
    function renderHistoryList() {
      historyList.innerHTML = '';
      
      chatSessions.forEach(session => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        if (session.id === currentSessionId) {
          historyItem.classList.add('active');
        }
        
        historyItem.textContent = session.title;
        historyItem.addEventListener('click', () => {
          loadChatSession(session.id);
          if (window.innerWidth <= 768) {
            sidebar.classList.remove('open');
          }
        });
        
        historyList.appendChild(historyItem);
      });
    }

    // åŠ è½½ç‰¹å®šå¯¹è¯ä¼šè¯
    function loadChatSession(sessionId) {
      const session = chatSessions.find(s => s.id === sessionId);
      if (!session) return;
      
      currentSessionId = sessionId;
      conversationHistory = [...session.messages];
      chatTitle.textContent = session.title;
      
      // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“èŠå¤©å†…å®¹
      chatContainer.innerHTML = '';
      session.messages.forEach(msg => {
        addMessage(msg.role === 'user' ? 'user' : 'ai', msg.content, false);
      });
      
      // æ›´æ–°å†å²åˆ—è¡¨é«˜äº®
      renderHistoryList();
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      scrollToBottom();
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
    function addMessage(sender, content, saveToHistory = true) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message message-${sender}`;
      
      const avatarClass = sender === 'user' ? 'avatar-user' : 'avatar-ai';
      const avatarIcon = sender === 'user' ? 'fas fa-user' : 'fas fa-child';
      
      messageDiv.innerHTML = `
        <div class="message-content">
          <div class="avatar ${avatarClass}">
            <i class="${avatarIcon}"></i>
          </div>
          <div class="message-text">
            <p>${content.replace(/\n/g, '<br>')}</p>
            <div class="message-actions">
              <button class="action-btn" onclick="copyToClipboard('${content.replace(/'/g, "\\'")}')">
                <i class="far fa-copy"></i> å¤åˆ¶
              </button>
            </div>
          </div>
        </div>
      `;
      
      chatContainer.appendChild(messageDiv);
      
      if (saveToHistory) {
        // ä¿å­˜åˆ°å½“å‰ä¼šè¯
        const session = chatSessions.find(s => s.id === currentSessionId);
        if (session) {
          session.messages.push({
            role: sender === 'user' ? 'user' : 'assistant',
            content: content
          });
          
          // æ›´æ–°ä¼šè¯æ ‡é¢˜ï¼ˆä½¿ç”¨ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼‰
          if (session.title === 'æ–°å¯¹è¯' && sender === 'user') {
            session.title = content.length > 20 ? content.substring(0, 20) + '...' : content;
            chatTitle.textContent = session.title;
          }
          
          saveChatSessions();
          renderHistoryList();
        }
      }
      
      scrollToBottom();
    }

    // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
    function showTypingIndicator() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message message-ai';
      messageDiv.id = 'typing-indicator';
      
      messageDiv.innerHTML = `
        <div class="message-content">
          <div class="avatar avatar-ai">
            <i class="fas fa-child"></i>
          </div>
          <div class="message-text">
            <div class="typing-indicator">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        </div>
      `;
      
      chatContainer.appendChild(messageDiv);
      scrollToBottom();
    }

    // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
    function removeTypingIndicator() {
      const indicator = document.getElementById('typing-indicator');
      if (indicator) {
        indicator.remove();
      }
    }

    // å‘é€æ¶ˆæ¯
    // å‘é€æ¶ˆæ¯å‡½æ•° - ä¿®å¤ç‰ˆæœ¬ï¼ˆåŒ…å«çŸ¥è¯†åº“é›†æˆï¼‰
async function sendMessage() {
  const message = userInput.value.trim();
  if (!message) return;

  const chatBox = document.getElementById('chatContainer');
  const currentTime = getCurrentTime();
  
  // åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºç”¨æˆ·è¾“å…¥
  chatBox.innerHTML += `
    <div class="message user-message">
      <div class="message-content">
        <div class="avatar avatar-user">
          <i class="fas fa-user"></i>
        </div>
        <div class="message-text">
          <p>${message}</p>
          <div class="message-time">${currentTime}</div>
        </div>
      </div>
    </div>
  `;
  userInput.value = '';
  userInput.style.height = 'auto';
  
  // æ˜¾ç¤º"æ€è€ƒä¸­"çš„æç¤º
  const thinkingId = "thinking-" + Date.now();
  chatBox.innerHTML += `
    <div class="message ai-message" id="${thinkingId}">
      <div class="message-content">
        <div class="avatar avatar-ai">
          <i class="fas fa-child"></i>
        </div>
        <div class="message-text">
          <p>ç±³å°å…œæ­£åœ¨æ€è€ƒ...</p>
          <div class="message-time">${currentTime}</div>
        </div>
      </div>
    </div>
  `;
  chatBox.scrollTop = chatBox.scrollHeight;

  try {
    // å°†ç”¨æˆ·çš„æ–°æ¶ˆæ¯åŠ å…¥å†å²
    conversationHistory.push({ role: "user", content: message });

    // æ„å»ºç³»ç»Ÿæç¤ºè¯ - ä¿®å¤ç‰ˆæœ¬
    let systemMessage = "ä½ æ˜¯ä¸€ä¸ªåå«ç±³å°å…œçš„AIåŠ©æ‰‹ï¼Œå›ç­”é£æ ¼äº²åˆ‡å‹å–„ã€ä¸“ä¸šä¸”ç®€æ´ã€‚";
    
    // ä»çŸ¥è¯†åº“ä¸­æœç´¢ç›¸å…³å†…å®¹
    const relevantKnowledge = searchKnowledgeInBase(message);
    
    // å¦‚æœæœ‰ç›¸å…³çŸ¥è¯†ï¼Œä¼˜å…ˆä½¿ç”¨çŸ¥è¯†åº“ä¿¡æ¯
    if (relevantKnowledge.length > 0) {
      systemMessage += "\n\nã€é‡è¦æŒ‡ä»¤ã€‘è¯·ä¼˜å…ˆå‚è€ƒä»¥ä¸‹ç”¨æˆ·æä¾›çš„çŸ¥è¯†åº“ä¿¡æ¯æ¥å›ç­”é—®é¢˜ã€‚è¿™äº›æ˜¯ç”¨æˆ·çš„çœŸå®ä¿¡æ¯ï¼š\n";
      relevantKnowledge.forEach((item, index) => {
        systemMessage += `--- çŸ¥è¯†æ¡ç›® ${index + 1} ---\n${item.content}\n\n`;
      });
      systemMessage += "è¯·ç›´æ¥åŸºäºä»¥ä¸ŠçŸ¥è¯†åº“ä¿¡æ¯å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œä¸è¦è¦æ±‚ç”¨æˆ·é‡å¤æä¾›è¿™äº›ä¿¡æ¯ã€‚";
      
      // è°ƒè¯•ä¿¡æ¯
      console.log('ğŸ” æ‰¾åˆ°ç›¸å…³çŸ¥è¯†:', relevantKnowledge);
    } else {
      console.log('âŒ æœªæ‰¾åˆ°ç›¸å…³çŸ¥è¯†');
    }
    
    if (isDeepThinking) {
      systemMessage += "è¯·æä¾›æ·±å…¥ã€è¯¦ç»†çš„åˆ†æå’Œæ€è€ƒè¿‡ç¨‹ã€‚";
    }
    
    if (isWebSearch) {
      systemMessage += "å¦‚æœç”¨æˆ·çš„é—®é¢˜éœ€è¦æœ€æ–°ä¿¡æ¯ï¼Œè¯·è¯´æ˜è¿™äº›ä¿¡æ¯å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ï¼Œå¹¶å»ºè®®å¼€å¯è”ç½‘æœç´¢åŠŸèƒ½ã€‚";
    }

    const messages = [
      { role: "system", content: systemMessage },
      ...conversationHistory
    ];

    // è°ƒç”¨åƒé—®API
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_KEY}`
      },
      body: JSON.stringify({
        model: MODEL_NAME,
        messages: messages,
        temperature: isDeepThinking ? 0.7 : 0.5
      })
    });

    if (!response.ok) {
      throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
    }

    const data = await response.json();
    const aiReply = data.choices[0].message.content;
    lastAIResponse = aiReply;
    
    // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨å¹¶æ·»åŠ AIå›å¤
    document.getElementById(thinkingId).outerHTML = `
      <div class="message ai-message">
        <div class="message-content">
          <div class="avatar avatar-ai">
            <i class="fas fa-child"></i>
          </div>
          <div class="message-text">
            <p>${aiReply}</p>
            <div class="message-time">${getCurrentTime()}</div>
          </div>
        </div>
      </div>
    `;
    
    // æ›´æ–°å¯¹è¯å†å²
    conversationHistory.push({ role: "assistant", content: aiReply });
    
    // å¯ç”¨æœ—è¯»æŒ‰é’®
    document.getElementById('speakButton').disabled = false;
    
  } catch (error) {
    console.error('å‡ºé”™äº†:', error);
    document.getElementById(thinkingId).outerHTML = `
      <div class="message ai-message">
        <div class="message-content">
          <div class="avatar avatar-ai">
            <i class="fas fa-child"></i>
          </div>
          <div class="message-text">
            <p>æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›åº”ã€‚é”™è¯¯è¯¦æƒ…: ${error.message}</p>
            <div class="message-time">${getCurrentTime()}</div>
          </div>
        </div>
      </div>
    `;
  }
  
  // ç¡®ä¿èŠå¤©æ¡†æ»šåŠ¨åˆ°åº•éƒ¨
  chatBox.scrollTop = chatBox.scrollHeight;
}
        
        // æ·»åŠ ç³»ç»Ÿæç¤ºï¼ˆæ ¹æ®é€‰é¡¹ï¼‰
        let systemMessage = "ä½ æ˜¯ä¸€ä¸ªåå«ç±³å°å…œçš„AIåŠ©æ‰‹ï¼Œå›ç­”é£æ ¼äº²åˆ‡å‹å–„ã€ä¸“ä¸šä¸”ç®€æ´ã€‚";
        
        if (isDeepThinking) {
          systemMessage += "è¯·æä¾›æ·±å…¥ã€è¯¦ç»†çš„åˆ†æå’Œæ€è€ƒè¿‡ç¨‹ã€‚";
        }
        
        if (isWebSearch) {
          systemMessage += "å¦‚æœç”¨æˆ·çš„é—®é¢˜éœ€è¦æœ€æ–°ä¿¡æ¯ï¼Œè¯·è¯´æ˜è¿™äº›ä¿¡æ¯å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ï¼Œå¹¶å»ºè®®å¼€å¯è”ç½‘æœç´¢åŠŸèƒ½ã€‚";
        }
        
        // ä»çŸ¥è¯†åº“ä¸­æœç´¢ç›¸å…³å†…å®¹
        const relevantKnowledge = searchKnowledgeInBase(message);
        if (relevantKnowledge.length > 0) {
          systemMessage += "\n\nä»¥ä¸‹æ˜¯ç”¨æˆ·çš„çŸ¥è¯†åº“å†…å®¹ï¼Œè¯·å‚è€ƒè¿™äº›ä¿¡æ¯å›ç­”é—®é¢˜ï¼š\n";
          relevantKnowledge.forEach(item => {
            systemMessage += `- ${item.content}\n`;
          });
        }
        
        const messages = [
          { role: "system", content: systemMessage },
          ...conversationHistory
        ];
        
        // è°ƒç”¨API
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_KEY}`
          },
          body: JSON.stringify({
            model: MODEL_NAME,
            messages: messages,
            temperature: isDeepThinking ? 0.7 : 0.5
          })
        });

        if (!response.ok) {
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        }

        const data = await response.json();
        const aiReply = data.choices[0].message.content;
        lastAIResponse = aiReply;
        
        // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨å¹¶æ·»åŠ AIå›å¤
        removeTypingIndicator();
        addMessage('ai', aiReply);
        
        // æ›´æ–°å¯¹è¯å†å²
        conversationHistory.push({ role: "assistant", content: aiReply });
        
      } catch (error) {
        console.error('å‡ºé”™äº†:', error);
        removeTypingIndicator();
        addMessage('ai', `æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›åº”ã€‚é”™è¯¯è¯¦æƒ…: ${error.message}`);
      }
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        // å¯ä»¥æ·»åŠ å¤åˆ¶æˆåŠŸçš„æç¤º
      });
    }

    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // è¯­éŸ³è¯†åˆ«åŠŸèƒ½
    function initializeVoiceRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      
      if (!SpeechRecognition) {
        voiceButton.disabled = true;
        voiceButton.title = "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«";
        return;
      }
      
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'zh-CN';
      
      recognition.onstart = function() {
        isListening = true;
        voiceButton.classList.add('listening');
        voiceStatus.textContent = "æ­£åœ¨è†å¬...è¯·è¯´è¯";
      };
      
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
        voiceStatus.textContent = `è¯†åˆ«ç»“æœ: ${transcript}`;
        
        // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŒºåŸŸé«˜åº¦
        userInput.style.height = 'auto';
        userInput.style.height = (userInput.scrollHeight) + 'px';
      };
      
      recognition.onerror = function(event) {
        let errorMessage = 'è¯­éŸ³è¯†åˆ«é”™è¯¯: ';
        
        switch(event.error) {
          case 'not-allowed':
          case 'permission-denied':
            errorMessage += 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚è¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®ï¼Œå…è®¸ç½‘ç«™ä½¿ç”¨éº¦å…‹é£ã€‚';
            break;
          case 'no-speech':
            errorMessage += 'æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³è¾“å…¥ã€‚è¯·ç¡®ä¿éº¦å…‹é£æ­£å¸¸å·¥ä½œå¹¶è¯´è¯ã€‚';
            break;
          case 'audio-capture':
            errorMessage += 'æ— æ³•æ•è·éŸ³é¢‘ã€‚è¯·æ£€æŸ¥éº¦å…‹é£è®¾å¤‡æ˜¯å¦è¿æ¥æ­£å¸¸ã€‚';
            break;
          case 'network':
            errorMessage += 'ç½‘ç»œé”™è¯¯å¯¼è‡´è¯­éŸ³è¯†åˆ«å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚';
            break;
          default:
            errorMessage += event.error;
        }
        
        voiceStatus.textContent = errorMessage;
        stopVoiceRecognition();
      };
      
      recognition.onend = function() {
        stopVoiceRecognition();
      };
    }
    
    function toggleVoiceRecognition() {
      if (!recognition) {
        voiceStatus.textContent = "è¯­éŸ³è¯†åˆ«æœªåˆå§‹åŒ–";
        return;
      }
      
      if (isListening) {
        stopVoiceRecognition();
      } else {
        startVoiceRecognition();
      }
    }
    
    function startVoiceRecognition() {
      try {
        recognition.start();
      } catch (error) {
        console.error('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
        voiceStatus.textContent = "å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•";
      }
    }
    
    function stopVoiceRecognition() {
      if (recognition && isListening) {
        recognition.stop();
      }
      isListening = false;
      voiceButton.classList.remove('listening');
    }

    // çŸ¥è¯†åº“åŠŸèƒ½
    function loadKnowledgeBase() {
      const saved = localStorage.getItem('knowledgeBase');
      if (saved) {
        knowledgeBase = JSON.parse(saved);
        renderKnowledgeList();
      }
    }

    function saveKnowledgeBase() {
      localStorage.setItem('knowledgeBase', JSON.stringify(knowledgeBase));
    }

    function addKnowledge() {
      const content = knowledgeInput.value.trim();
      const tags = knowledgeTags.value.split(',').map(tag => tag.trim()).filter(tag => tag);
      
      if (!content) return;
      
      const knowledgeItem = {
        id: Date.now(),
        content: content,
        tags: tags,
        createdAt: new Date().toISOString()
      };
      
      knowledgeBase.push(knowledgeItem);
      saveKnowledgeBase();
      renderKnowledgeList();
      
      // æ¸…ç©ºè¾“å…¥
      knowledgeInput.value = '';
      knowledgeTags.value = '';
    }

    function searchKnowledgeBase() {
      const query = searchKnowledge.value.trim().toLowerCase();
      if (!query) {
        renderKnowledgeList();
        return;
      }
      
      const filteredKnowledge = knowledgeBase.filter(item => {
        const contentMatch = item.content.toLowerCase().includes(query);
        const tagsMatch = item.tags.some(tag => tag.toLowerCase().includes(query));
        return contentMatch || tagsMatch;
      });
      
      renderKnowledgeList(filteredKnowledge);
    }

    function searchKnowledgeInBase(query) {
      const keywords = query.toLowerCase().split(' ');
      return knowledgeBase.filter(item => {
        const content = item.content.toLowerCase();
        return keywords.some(keyword => content.includes(keyword));
      }).slice(0, 3); // è¿”å›æœ€ç›¸å…³çš„3æ¡
    }

    function renderKnowledgeList(knowledgeArray = knowledgeBase) {
      knowledgeList.innerHTML = '';
      
      if (knowledgeArray.length === 0) {
        knowledgeList.innerHTML = '<p style="text-align: center; color: var(--text-muted);">æš‚æ— çŸ¥è¯†æ¡ç›®</p>';
        return;
      }
      
      knowledgeArray.forEach(item => {
        const knowledgeItem = document.createElement('div');
        knowledgeItem.className = 'knowledge-item';
        
        knowledgeItem.innerHTML = `
          <div class="knowledge-content">${item.content}</div>
          <div class="knowledge-meta">
            <span>æ ‡ç­¾: ${item.tags.join(', ') || 'æ— '}</span>
            <span>${new Date(item.createdAt).toLocaleDateString()}</span>
          </div>
        `;
        
        knowledgeList.appendChild(knowledgeItem);
      });
    }
  </script>
</body>
</html>